<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nexora ‚Äî –Ω–µ–∫—Å—É—Å—ã</title>
  <link rel="stylesheet" href="/style-v2.css" />
  <script>
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const shouldBeLight = savedTheme === 'light' || (!savedTheme && !prefersDark);
      if (shouldBeLight) {
        document.documentElement.classList.add('light');
      }
    })();
  </script>
  <script src="/theme-toggle.js" defer></script>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-circle">‚ú®</div>
        <div class="logo-text">
          <div class="logo-name">Nexora</div>
          <div class="logo-subtitle">–Ω–µ–∫—Å—É—Å—ã –∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞</div>
        </div>
      </div>

      <div class="current-user" id="profile-link" style="cursor: pointer;">
        <span class="current-user-label">–í—ã:</span>
        <span class="current-user-name" id="current-username">...</span>
      </div>

      <button id="theme-toggle" class="theme-toggle" style="width: 100%; margin-bottom: 10px;">üåô</button>

      <a
        href="/chat"
        class="btn-secondary"
        style="width: 100%; margin: 6px 0; text-align: center; text-decoration: none;"
      >
        üí¨ –ö —á–∞—Ç–∞–º
      </a>

      <a
        id="admin-panel-btn"
        href="/admin.html"
        class="btn-primary"
        style="width: 100%; margin: 6px 0; display: none; text-align: center; text-decoration: none;"
      >
        ‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
      </a>
    </aside>

    <main class="chat-main">
      <div class="chat-main-header">
        <div class="chat-main-top">
          <div class="chat-main-titles">
            <div class="chat-main-title">üß≠ –ù–µ–∫—Å—É—Å—ã</div>
            <div class="chat-main-subtitle">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –Ω–µ–∫—Å—É—Å—ã, –ø–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –∏ —á–∏—Ç–∞–π—Ç–µ –ø–æ—Å—Ç—ã.</div>
          </div>
        </div>
      </div>

      <section class="nexus-section">
        <div class="nexus-form-card">
          <h3>–°–æ–∑–¥–∞—Ç—å –Ω–µ–∫—Å—É—Å</h3>
          <form id="nexus-create-form" class="nexus-form" enctype="multipart/form-data">
            <div class="nexus-form-row">
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input type="text" name="title" id="nexus-title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ù–æ–≤—ã–µ –∏–¥–µ–∏" required />
            </div>
            <div class="nexus-form-row">
              <label>–ù–∏–∫ (–ª–∞—Ç–∏–Ω–∏—Ü–∞)</label>
              <div class="nexus-handle-input">
                <span>@</span>
                <input type="text" name="handle" id="nexus-handle" placeholder="nexus_ideas" required />
              </div>
            </div>
            <div class="nexus-form-row">
              <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea name="description" id="nexus-description" rows="3" placeholder="–û —á–µ–º —ç—Ç–æ—Ç –Ω–µ–∫—Å—É—Å?"></textarea>
            </div>
            <div class="nexus-form-row">
              <label>–ê–≤–∞—Ç–∞—Ä</label>
              <input type="file" name="avatar" id="nexus-avatar" accept="image/*" />
            </div>
            <div class="nexus-form-actions">
              <button type="submit" class="btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
              <button type="reset" class="btn-secondary" onclick="document.getElementById('nexus-create-form').reset()">–û—Ç–º–µ–Ω–∞</button>
              <div id="nexus-error" class="nexus-error"></div>
            </div>
          </form>
        </div>

        <div class="nexus-list" id="nexus-list"></div>
      </section>
    </main>
  </div>

  <script>
    const currentUsernameEl = document.getElementById('current-username');
    const adminPanelBtn = document.getElementById('admin-panel-btn');
    const nexusListEl = document.getElementById('nexus-list');
    const createForm = document.getElementById('nexus-create-form');
    const nexusErrorEl = document.getElementById('nexus-error');

    let currentUser = null;

    async function loadMe() {
      const res = await fetch('/me');
      const data = await res.json();
      if (!data.loggedIn) {
        window.location.href = '/login.html';
        return;
      }
      currentUser = data;
      currentUsernameEl.textContent = data.displayName || data.username;
      if (data.isAdmin) {
        adminPanelBtn.style.display = 'block';
      }
      document.getElementById('profile-link').onclick = () => {
        window.location.href = '/profile.html';
      };
    }

    function createAvatarNode(avatarUrl, title) {
      const avatar = document.createElement('div');
      avatar.className = 'nexus-avatar';
      if (avatarUrl) {
        avatar.style.backgroundImage = `url(${avatarUrl})`;
      } else {
        avatar.textContent = (title || 'N').trim().charAt(0).toUpperCase();
      }
      return avatar;
    }

    function renderNexusCard(item) {
      const card = document.createElement('div');
      card.className = 'nexus-card';

      const header = document.createElement('div');
      header.className = 'nexus-card-header';

      const avatar = createAvatarNode(item.avatar_data, item.title);

      const info = document.createElement('div');
      info.className = 'nexus-info';

      const title = document.createElement('div');
      title.className = 'nexus-title';
      title.textContent = item.title;

      const handle = document.createElement('div');
      handle.className = 'nexus-handle';
      handle.textContent = `@${item.handle}`;

      const meta = document.createElement('div');
      meta.className = 'nexus-meta';
      const authorName = item.author_display_name || item.author_username;
      meta.textContent = `–ê–≤—Ç–æ—Ä: ${authorName} ¬∑ –ü–æ–¥–ø–∏—Å—á–∏–∫–∏: ${item.subscribers_count} ¬∑ –ü–æ—Å—Ç—ã: ${item.posts_count}`;

      info.appendChild(title);
      info.appendChild(handle);
      info.appendChild(meta);

      header.appendChild(avatar);
      header.appendChild(info);

      const desc = document.createElement('div');
      desc.className = 'nexus-desc';
      desc.textContent = item.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è';

      const actions = document.createElement('div');
      actions.className = 'nexus-actions';

      const openBtn = document.createElement('button');
      openBtn.className = 'btn-secondary';
      openBtn.textContent = '–û—Ç–∫—Ä—ã—Ç—å';
      openBtn.onclick = () => {
        window.location.href = `/nexus/profile?id=${item.id}`;
      };

      actions.appendChild(openBtn);

      const role = item.my_role;
      if (role === 'owner') {
        const ownerBadge = document.createElement('span');
        ownerBadge.className = 'nexus-badge';
        ownerBadge.textContent = '–í–ª–∞–¥–µ–ª–µ—Ü';
        actions.appendChild(ownerBadge);
      } else {
        const subBtn = document.createElement('button');
        subBtn.className = role ? 'btn-ghost' : 'btn-primary';
        subBtn.textContent = role ? '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è' : '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
        subBtn.onclick = async () => {
          subBtn.disabled = true;
          try {
            if (role) {
              await fetch(`/api/nexus/${item.id}/unsubscribe`, { method: 'POST' });
            } else {
              await fetch(`/api/nexus/${item.id}/subscribe`, { method: 'POST' });
            }
            await loadNexus();
          } catch (err) {
            console.error(err);
          } finally {
            subBtn.disabled = false;
          }
        };
        actions.appendChild(subBtn);
      }

      card.appendChild(header);
      card.appendChild(desc);
      card.appendChild(actions);

      return card;
    }

    async function loadNexus() {
      nexusListEl.innerHTML = '<div class="nexus-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
      const res = await fetch('/api/nexus');
      const data = await res.json();
      if (!data.ok) {
        nexusListEl.innerHTML = '<div class="nexus-error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ–∫—Å—É—Å—ã</div>';
        return;
      }

      nexusListEl.innerHTML = '';
      if (data.nexus.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'nexus-empty';
        empty.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –Ω–µ–∫—Å—É—Å–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!';
        nexusListEl.appendChild(empty);
        return;
      }

      data.nexus.forEach((item) => {
        nexusListEl.appendChild(renderNexusCard(item));
      });
    }

    createForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      nexusErrorEl.textContent = '';

      const formData = new FormData(createForm);
      const res = await fetch('/api/nexus', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      if (!data.ok) {
        nexusErrorEl.textContent = data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–µ–∫—Å—É—Å';
        return;
      }

      createForm.reset();
      await loadNexus();
    });

    (async () => {
      await loadMe();
      await loadNexus();
    })();
  </script>
</body>
</html>
