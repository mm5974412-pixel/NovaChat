<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nexora ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–∫—Å—É—Å–æ–º</title>
  <link rel="stylesheet" href="/style-v2.css" />
  <script>
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const shouldBeLight = savedTheme === 'light' || (!savedTheme && !prefersDark);
      if (shouldBeLight) {
        document.documentElement.classList.add('light');
      }
    })();
  </script>
  <script src="/theme-toggle.js" defer></script>
  <style>
    .nexus-edit-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 20px;
    }

    @media (max-width: 1024px) {
      .nexus-edit-container {
        grid-template-columns: 1fr;
      }
    }

    .edit-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
    }

    .edit-section h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--primary);
    }

    .edit-section label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--text);
    }

    .edit-section input,
    .edit-section textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--input-bg);
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
    }

    .edit-section input:focus,
    .edit-section textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.1);
    }

    .avatar-preview {
      width: 120px;
      height: 120px;
      border-radius: 8px;
      background: var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      margin-bottom: 15px;
      background-size: cover;
      background-position: center;
      color: var(--text);
    }

    .subscribers-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .subscriber-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid var(--border);
    }

    .subscriber-item:last-child {
      border-bottom: none;
    }

    .subscriber-info {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }

    .subscriber-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      background-size: cover;
      background-position: center;
      color: var(--text);
    }

    .subscriber-details {
      flex: 1;
    }

    .subscriber-name {
      font-weight: 500;
      color: var(--text);
    }

    .subscriber-username {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .subscriber-delete {
      padding: 5px 10px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .subscriber-delete:hover {
      background: var(--danger-hover);
    }

    .form-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .form-buttons button {
      flex: 1;
    }

    .error-message {
      color: var(--danger);
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(255, 0, 0, 0.1);
      border-radius: 4px;
    }

    .success-message {
      color: var(--success);
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(0, 255, 0, 0.1);
      border-radius: 4px;
    }

    .handle-input-group {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .handle-input-group input {
      flex: 1;
      margin-bottom: 15px;
    }

    .handle-prefix {
      padding: 10px 0;
      color: var(--text-secondary);
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-circle">‚ú®</div>
        <div class="logo-text">
          <div class="logo-name">Nexora</div>
          <div class="logo-subtitle">—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–∫—Å—É—Å–æ–º</div>
        </div>
      </div>

      <div class="current-user" id="profile-link" style="cursor: pointer;">
        <span class="current-user-label">–í—ã:</span>
        <span class="current-user-name" id="current-username">...</span>
      </div>

      <button id="theme-toggle" class="theme-toggle" style="width: 100%; margin-bottom: 10px;">üåô</button>

      <a
        id="back-link"
        href="#"
        class="btn-secondary"
        style="width: 100%; margin: 6px 0; text-align: center; text-decoration: none;"
      >
        ‚Üê –ù–∞–∑–∞–¥ –∫ –Ω–µ–∫—Å—É—Å—É
      </a>

      <a
        href="/nexus"
        class="btn-secondary"
        style="width: 100%; margin: 6px 0; text-align: center; text-decoration: none;"
      >
        üìã –ö –Ω–µ–∫—Å—É—Å–∞–º
      </a>
    </aside>

    <main class="chat-main">
      <div class="chat-main-header">
        <div class="chat-main-top">
          <div class="chat-main-titles">
            <div class="chat-main-title">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–∫—Å—É—Å–æ–º</div>
            <div class="chat-main-subtitle" id="nexus-subtitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
          </div>
        </div>
      </div>

      <section class="nexus-edit-container">
        <div class="edit-section">
          <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–µ–∫—Å—É—Å–µ</h3>
          <div id="edit-error" class="error-message" style="display: none;"></div>
          <div id="edit-success" class="success-message" style="display: none;"></div>

          <form id="nexus-edit-form">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" id="edit-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ–∫—Å—É—Å–∞" required />

            <label>–ù–∏–∫ (–ª–∞—Ç–∏–Ω–∏—Ü–∞)</label>
            <div class="handle-input-group">
              <span class="handle-prefix">@</span>
              <input type="text" id="edit-handle" placeholder="nexus_id" required />
            </div>

            <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="edit-description" rows="4" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–∫—Å—É—Å–∞"></textarea>

            <label>–ê–≤–∞—Ç–∞—Ä</label>
            <div class="avatar-preview" id="avatar-preview"></div>
            <input type="file" id="edit-avatar" accept="image/*" />

            <div class="form-buttons">
              <button type="submit" class="btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button type="button" class="btn-secondary" onclick="goBack()">–û—Ç–º–µ–Ω–∞</button>
            </div>
          </form>
        </div>

        <div class="edit-section">
          <h3>–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</h3>
          <div id="subscribers-count" style="margin-bottom: 15px; color: var(--text-secondary); font-size: 14px;"></div>
          <div class="subscribers-list" id="subscribers-list">
            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const nexusId = params.get('id');

    let currentUser = null;
    let currentNexus = null;
    let selectedFile = null;

    function goBack() {
      window.location.href = `/nexus/profile?id=${nexusId}`;
    }

    async function loadMe() {
      const res = await fetch('/me');
      const data = await res.json();
      if (!data.loggedIn) {
        window.location.href = '/login.html';
        return;
      }
      currentUser = data;
      document.getElementById('current-username').textContent = data.displayName || data.username;
      document.getElementById('profile-link').onclick = () => {
        window.location.href = '/profile.html';
      };
    }

    async function loadNexus() {
      if (!nexusId) {
        document.querySelector('.chat-main-titles').innerHTML = '<div class="nexus-error">–ù–µ–∫—Å—É—Å –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
        return;
      }

      const res = await fetch(`/api/nexus/${nexusId}`);
      const data = await res.json();
      if (!data.ok) {
        document.querySelector('.chat-main-titles').innerHTML = `<div class="nexus-error">${data.error || '–ù–µ–∫—Å—É—Å –Ω–µ –Ω–∞–π–¥–µ–Ω'}</div>`;
        return;
      }

      currentNexus = data.nexus;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ª–∞–¥–µ–ª–µ—Ü
      if (currentNexus.author_id !== currentUser.id) {
        window.location.href = `/nexus/profile?id=${nexusId}`;
        return;
      }

      document.getElementById('nexus-subtitle').textContent = `@${currentNexus.handle}`;
      document.getElementById('back-link').href = `/nexus/profile?id=${nexusId}`;

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ä–º—É
      document.getElementById('edit-title').value = currentNexus.title;
      document.getElementById('edit-handle').value = currentNexus.handle;
      document.getElementById('edit-description').value = currentNexus.description || '';

      if (currentNexus.avatar_data) {
        document.getElementById('avatar-preview').style.backgroundImage = `url(${currentNexus.avatar_data})`;
      } else {
        document.getElementById('avatar-preview').textContent = (currentNexus.title || 'N').trim().charAt(0).toUpperCase();
      }

      await loadSubscribers();
    }

    async function loadSubscribers() {
      try {
        const res = await fetch(`/api/nexus/${nexusId}/subscribers`);
        const data = await res.json();
        if (!data.ok) {
          document.getElementById('subscribers-list').innerHTML = `<div class="nexus-error">${data.error}</div>`;
          return;
        }

        const subscribers = data.subscribers;
        document.getElementById('subscribers-count').textContent = `–í—Å–µ–≥–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤: ${subscribers.length}`;

        const listEl = document.getElementById('subscribers-list');
        listEl.innerHTML = '';

        if (subscribers.length === 0) {
          listEl.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">–ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –Ω–µ—Ç</div>';
          return;
        }

        subscribers.forEach(sub => {
          const item = document.createElement('div');
          item.className = 'subscriber-item';

          const info = document.createElement('div');
          info.className = 'subscriber-info';

          const avatar = document.createElement('div');
          avatar.className = 'subscriber-avatar';
          if (sub.avatar_data) {
            avatar.style.backgroundImage = `url(${sub.avatar_data})`;
          } else {
            avatar.textContent = (sub.display_name || sub.username || 'U').trim().charAt(0).toUpperCase();
          }

          const details = document.createElement('div');
          details.className = 'subscriber-details';

          const name = document.createElement('div');
          name.className = 'subscriber-name';
          name.textContent = sub.display_name || sub.username;

          const username = document.createElement('div');
          username.className = 'subscriber-username';
          username.textContent = `@${sub.username}`;

          details.appendChild(name);
          details.appendChild(username);
          info.appendChild(avatar);
          info.appendChild(details);

          if (sub.role !== 'owner') {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'subscriber-delete';
            deleteBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
            deleteBtn.onclick = async () => {
              if (confirm(`–£–¥–∞–ª–∏—Ç—å ${sub.display_name || sub.username} –∏–∑ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤?`)) {
                await deleteSubscriber(sub.user_id);
              }
            };
            item.appendChild(deleteBtn);
          }

          item.appendChild(info);
          listEl.appendChild(item);
        });
      } catch (err) {
        console.error(err);
        document.getElementById('subscribers-list').innerHTML = '<div class="nexus-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</div>';
      }
    }

    async function deleteSubscriber(userId) {
      try {
        const res = await fetch(`/api/nexus/${nexusId}/subscribers/${userId}`, {
          method: 'DELETE'
        });
        const data = await res.json();
        if (data.ok) {
          await loadSubscribers();
        } else {
          alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
        }
      } catch (err) {
        console.error(err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞');
      }
    }

    document.getElementById('edit-avatar').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          document.getElementById('avatar-preview').style.backgroundImage = `url(${event.target.result})`;
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('nexus-edit-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const errorEl = document.getElementById('edit-error');
      const successEl = document.getElementById('edit-success');
      errorEl.style.display = 'none';
      successEl.style.display = 'none';

      const title = document.getElementById('edit-title').value.trim();
      const handle = document.getElementById('edit-handle').value.trim();
      const description = document.getElementById('edit-description').value.trim();

      if (!title || !handle) {
        errorEl.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –Ω–∏–∫';
        errorEl.style.display = 'block';
        return;
      }

      const formData = new FormData();
      formData.append('title', title);
      formData.append('handle', handle);
      formData.append('description', description);

      const avatarInput = document.getElementById('edit-avatar');
      if (avatarInput.files.length > 0) {
        formData.append('avatar', avatarInput.files[0]);
      }

      try {
        const res = await fetch(`/api/nexus/${nexusId}`, {
          method: 'PATCH',
          body: formData
        });

        const data = await res.json();
        if (!data.ok) {
          errorEl.textContent = data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏';
          errorEl.style.display = 'block';
          return;
        }

        successEl.textContent = '‚úì –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';
        successEl.style.display = 'block';
        
        await loadNexus();
      } catch (err) {
        console.error(err);
        errorEl.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
        errorEl.style.display = 'block';
      }
    });

    (async () => {
      await loadMe();
      await loadNexus();
    })();
  </script>
</body>
</html>
