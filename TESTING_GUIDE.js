#!/usr/bin/env node

/**
 * NEXIS BOTS - TESTING GUIDE
 * Полное руководство по тестированию функциональности
 */

console.log(`
╔════════════════════════════════════════════════════════════════╗
║     🤖 NEXIS BOTS - ПОЛНОЕ РУКОВОДСТВО ПО ТЕСТИРОВАНИЮ        ║
╚════════════════════════════════════════════════════════════════╝

Это руководство поможет вам протестировать все функции системы
ботов Nexis для мессенджера NovaChat.

`);

console.log(`
📋 ПРЕДВАРИТЕЛЬНЫЕ ТРЕБОВАНИЯ
════════════════════════════════════════════════════════════════

✓ Node.js установлен
✓ PostgreSQL база данных работает
✓ npm зависимости установлены
✓ Сервер запущен (node server.js)
✓ Браузер открыт на http://localhost:3000

`);

console.log(`
🧪 ПЛАН ТЕСТИРОВАНИЯ
════════════════════════════════════════════════════════════════

ЧАСТЬ 1: Проверка Backend (API)
   ├── Тест 1.1 - Загрузка всех ботов
   ├── Тест 1.2 - Создание бота
   ├── Тест 1.3 - Подписка на бота
   ├── Тест 1.4 - Отправка команды
   └── Тест 1.5 - Клик по кнопке

ЧАСТЬ 2: Проверка Frontend UI
   ├── Тест 2.1 - Загрузка страницы nexis-bots.html
   ├── Тест 2.2 - Отображение ботов
   ├── Тест 2.3 - Подписка/отписка в UI
   ├── Тест 2.4 - Создание бота в UI
   └── Тест 2.5 - Просмотр деталей бота

ЧАСТЬ 3: Проверка Тестера
   ├── Тест 3.1 - Загрузка тестера
   ├── Тест 3.2 - Выбор бота
   ├── Тест 3.3 - Отправка команд
   ├── Тест 3.4 - Просмотр логов
   └── Тест 3.5 - Тестирование кнопок

ЧАСТЬ 4: Интеграция в чат
   ├── Тест 4.1 - Видимость кнопки
   ├── Тест 4.2 - Клик на кнопку
   └── Тест 4.3 - Переход на страницу ботов

`);

console.log(`
🚀 ЧАСТЬ 1: ТЕСТИРОВАНИЕ API
════════════════════════════════════════════════════════════════

ТЕСТ 1.1 - Получить список всех ботов
────────────────────────────────────────────────────────────────

curl -X GET http://localhost:3000/api/bots

Ожидаемый результат:
{
  "ok": true,
  "bots": [
    {
      "id": 1,
      "name": "...",
      "description": "...",
      "avatar_url": null,
      "is_active": true,
      "subscriber_count": 0,
      "created_at": "..."
    }
  ]
}

✓ Если получили пустой массив - это нормально
✓ Если получили ошибку - проверьте подключение к БД


ТЕСТ 1.2 - Создать нового бота
────────────────────────────────────────────────────────────────

curl -X POST http://localhost:3000/api/bots \\
  -H "Content-Type: application/json" \\
  -b "sessionId=YOUR_SESSION_ID" \\
  -d '{
    "name": "TestBot",
    "description": "Бот для тестирования",
    "commands": [
      {"cmd": "/start", "description": "Начать"}
    ]
  }'

Ожидаемый результат:
{
  "ok": true,
  "bot": {
    "id": 1,
    "name": "TestBot",
    "description": "Бот для тестирования",
    "avatar_url": null,
    "is_active": true,
    "created_at": "..."
  }
}

✓ Если получили 401 - авторизуйтесь в приложении
✓ Если ошибка с уникальностью имени - используйте другое имя


ТЕСТ 1.3 - Подписаться на бота
────────────────────────────────────────────────────────────────

curl -X POST http://localhost:3000/api/bots/1/subscribe \\
  -b "sessionId=YOUR_SESSION_ID"

Ожидаемый результат:
{
  "ok": true,
  "message": "Subscribed to bot"
}

✓ Если ошибка - проверьте ID бота
✓ Если 401 - авторизуйтесь


ТЕСТ 1.4 - Отправить команду боту
────────────────────────────────────────────────────────────────

curl -X POST http://localhost:3000/api/bots/1/command \\
  -H "Content-Type: application/json" \\
  -b "sessionId=YOUR_SESSION_ID" \\
  -d '{
    "command": "/start",
    "chatId": null
  }'

Ожидаемый результат:
{
  "ok": true,
  "response": {
    "text": "👋 Привет! Я TestBot...",
    "buttons": [...]
  }
}

✓ Текст должен содержать имя бота
✓ Если команда не распознана - получите соответствующее сообщение


ТЕСТ 1.5 - Клик по кнопке
────────────────────────────────────────────────────────────────

curl -X POST http://localhost:3000/api/bots/1/button-click \\
  -H "Content-Type: application/json" \\
  -b "sessionId=YOUR_SESSION_ID" \\
  -d '{
    "action": "help",
    "chatId": null
  }'

Ожидаемый результат:
{
  "ok": true,
  "response": {
    "text": "📚 Помощь по TestBot"
  }
}

✓ Любое действие должно вернуть ответ
✓ Текст должен быть информативным

`);

console.log(`
🌐 ЧАСТЬ 2: ТЕСТИРОВАНИЕ FRONTEND UI
════════════════════════════════════════════════════════════════

ТЕСТ 2.1 - Загрузить страницу nexis-bots.html
────────────────────────────────────────────────────────────────

1. Откройте http://localhost:3000/nexis-bots.html
2. Проверьте:
   ✓ Заголовок "🤖 Nexis Боты" видим
   ✓ Кнопка "+ Создать бота" присутствует
   ✓ Вкладки "Все боты", "Мои подписки", "Мои боты" видны
   ✓ Консоль браузера не содержит ошибок

Если все хорошо → ТЕСТ ПРОЙДЕН ✓


ТЕСТ 2.2 - Загрузка и отображение ботов
────────────────────────────────────────────────────────────────

1. На странице nexis-bots.html нажмите на вкладку "Все боты"
2. Проверьте:
   ✓ Боты загружаются из API (/api/bots)
   ✓ Карточки ботов отображаются
   ✓ Видна информация: имя, описание, количество подписчиков
   ✓ Кнопки "Подробнее" и "✅ Подписаться" присутствуют

Если все хорошо → ТЕСТ ПРОЙДЕН ✓


ТЕСТ 2.3 - Подписка и отписка через UI
────────────────────────────────────────────────────────────────

1. На странице nexis-bots.html нажмите "✅ Подписаться" на любого бота
2. Проверьте:
   ✓ Появилось уведомление "✅ Вы подписались на бота"
   ✓ Бот появился в разделе "Мои подписки"
3. Нажмите "❌ Отписаться"
4. Проверьте:
   ✓ Появилось уведомление "❌ Вы отписались от бота"
   ✓ Бот исчез из раздела "Мои подписки"

Если все хорошо → ТЕСТ ПРОЙДЕН ✓


ТЕСТ 2.4 - Создание бота через UI
────────────────────────────────────────────────────────────────

1. Нажмите кнопку "+ Создать бота"
2. Заполните форму:
   - Имя: "MyTestBot_" + текущие миллисекунды
   - Описание: "Тестовый бот"
   - URL аватара: (оставьте пусто)
3. Нажмите "Создать"
4. Проверьте:
   ✓ Появилось уведомление "✅ Бот успешно создан!"
   ✓ Модальное окно закрылось
   ✓ Новый бот появился в списке "Все боты"

Если все хорошо → ТЕСТ ПРОЙДЕН ✓


ТЕСТ 2.5 - Просмотр деталей бота
────────────────────────────────────────────────────────────────

1. На странице nexis-bots.html нажмите "Подробнее" на боте
2. Проверьте:
   ✓ Открылось модальное окно с деталями
   ✓ Видно имя бота
   ✓ Видно описание
   ✓ Видны команды бота
   ✓ Есть кнопка "Начать разговор"
3. Нажмите кнопку "Начать разговор"
4. Проверьте:
   ✓ Модальное окно закрылось
   ✓ В браузере появилось уведомление о выполнении команды

Если все хорошо → ТЕСТ ПРОЙДЕН ✓

`);

console.log(`
🧪 ЧАСТЬ 3: ТЕСТИРОВАНИЕ ТЕСТЕРА
════════════════════════════════════════════════════════════════

ТЕСТ 3.1 - Загрузить тестер
────────────────────────────────────────────────────────────────

1. Откройте http://localhost:3000/nexis-bot-tester.html
2. Проверьте:
   ✓ Страница загрузилась
   ✓ Заголовок "🤖 Nexis Bot Tester" видим
   ✓ Два раздела: "Боты" и "Тестирование команд"
   ✓ Консоль не содержит ошибок

Если все хорошо → ТЕСТ ПРОЙДЕН ✓


ТЕСТ 3.2 - Выбор бота
────────────────────────────────────────────────────────────────

1. Нажмите кнопку "🔄 Перезагрузить ботов"
2. Проверьте:
   ✓ Боты загружаются
   ✓ Появляется список ботов
3. Кликните на бота в списке
4. Проверьте:
   ✓ Бот выделяется
   ✓ Появляется информация о боте: ID, имя, описание, подписчиков

Если все хорошо → ТЕСТ ПРОЙДЕН ✓


ТЕСТ 3.3 - Отправка команд
────────────────────────────────────────────────────────────────

1. Выберите бота
2. Из выпадающего списка выберите "/start"
3. Нажмите "📤 Отправить команду"
4. Проверьте:
   ✓ В логе появилось сообщение [ℹ️] "Отправка команды..."
   ✓ Появилось сообщение [✅] с ответом бота
5. Попробуйте команду "/help"
6. Проверьте:
   ✓ Ответ содержит информацию о командах

Если все хорошо → ТЕСТ ПРОЙДЕН ✓


ТЕСТ 3.4 - Просмотр логов
────────────────────────────────────────────────────────────────

1. После выполнения команд проверьте раздел "Вывод"
2. Проверьте:
   ✓ Все действия залогированы
   ✓ Видны временные метки
   ✓ Цветное форматирование (зеленые - успех, красные - ошибки)
3. Нажмите "🗑️ Очистить лог"
4. Проверьте:
   ✓ Лог очистился

Если все хорошо → ТЕСТ ПРОЙДЕН ✓


ТЕСТ 3.5 - Тестирование кнопок
────────────────────────────────────────────────────────────────

1. Нажмите одну из кнопок быстрого действия:
   - "▶️ /start"
   - "❓ /help"
   - "⚙️ /settings"
2. Проверьте:
   ✓ Команда выполняется сразу
   ✓ Ответ появляется в логе

Если все хорошо → ТЕСТ ПРОЙДЕН ✓

`);

console.log(`
🔗 ЧАСТЬ 4: ИНТЕГРАЦИЯ В ЧАТ
════════════════════════════════════════════════════════════════

ТЕСТ 4.1 - Видимость кнопки в меню
────────────────────────────────────────────────────────────────

1. Откройте http://localhost:3000/chat.html
2. В левой боковой панели найдите кнопки
3. Проверьте:
   ✓ Видна кнопка "🤖 Nexis Боты"
   ✓ Кнопка расположена рядом с кнопками "🔍 Нексация" и "➕ Создать"

Если все хорошо → ТЕСТ ПРОЙДЕН ✓


ТЕСТ 4.2 - Клик на кнопку
────────────────────────────────────────────────────────────────

1. На странице chat.html нажмите кнопку "🤖 Nexis Боты"
2. Проверьте:
   ✓ Страница перенаправляется на /nexis-bots.html
   ✓ Загружается страница управления ботами

Если все хорошо → ТЕСТ ПРОЙДЕН ✓


ТЕСТ 4.3 - Полный цикл взаимодействия
────────────────────────────────────────────────────────────────

1. В chat.html нажмите "🤖 Nexis Боты"
2. Подпишитесь на бота
3. Нажмите на кнопку бота для просмотра деталей
4. Нажмите "Начать разговор"
5. Проверьте:
   ✓ Все действия выполняются корректно
   ✓ Нет ошибок в консоли браузера

Если все хорошо → ТЕСТ ПРОЙДЕН ✓

`);

console.log(`
✅ ИТОГОВАЯ ПРОВЕРКА
════════════════════════════════════════════════════════════════

ПРОВЕРЬТЕ СЛЕДУЮЩЕЕ:

Backend проверки:
   ☐ Все 8 API endpoints работают
   ☐ Возвращаются корректные ответы
   ☐ Авторизация проверяется (401 для неавторизованных)
   ☐ Ошибки обрабатываются корректно

Frontend проверки:
   ☐ nexis-bots.html загружается
   ☐ nexis-bot-tester.html работает
   ☐ chat.html содержит кнопку "Nexis Боты"
   ☐ Вся функциональность работает

База данных проверки:
   ☐ Таблицы создались при запуске
   ☐ Данные сохраняются корректно
   ☐ Связи между таблицами работают

Безопасность:
   ☐ Требуется авторизация для защищённых операций
   ☐ Входные данные валидируются
   ☐ SQL injection защита работает
   ☐ Действия логируются

`);

console.log(`
🐛 РЕШЕНИЕ ПРОБЛЕМ ПРИ ТЕСТИРОВАНИИ
════════════════════════════════════════════════════════════════

ПРОБЛЕМА: "Cannot GET /api/bots"
РЕШЕНИЕ: Убедитесь, что server.js запущен и содержит новый код

ПРОБЛЕМА: "Таблицы не создались"
РЕШЕНИЕ: Проверьте консоль сервера. Должно быть сообщение об инициализации БД

ПРОБЛЕМА: "401 Unauthorized"
РЕШЕНИЕ: Авторизуйтесь в приложении перед тестированием защищённых endpoints

ПРОБЛЕМА: "Ошибка в консоли браузера"
РЕШЕНИЕ: Проверьте console.log в DevTools (F12) и исправьте ошибку

ПРОБЛЕМА: "Боты не загружаются"
РЕШЕНИЕ: Проверьте подключение к БД и наличие таблицы nexis_bots

ПРОБЛЕМА: "Страница nexis-bots.html возвращает 404"
РЕШЕНИЕ: Убедитесь, что файл создан в /public/nexis-bots.html

`);

console.log(`
📊 ОЖИДАЕМЫЕ РЕЗУЛЬТАТЫ
════════════════════════════════════════════════════════════════

После успешного тестирования:

✅ Все API endpoints работают правильно
✅ Frontend интерфейсы отображаются корректно
✅ Данные сохраняются в БД
✅ Real-time обновления работают
✅ Уведомления появляются
✅ Логирование функционирует
✅ Безопасность обеспечена

`);

console.log(`
📝 ЗАПИСЬ РЕЗУЛЬТАТОВ
════════════════════════════════════════════════════════════════

При тестировании заполните чек-лист:

[_] Часть 1 - API тесты (5/5 тестов)
[_] Часть 2 - Frontend тесты (5/5 тестов)
[_] Часть 3 - Тестер (5/5 тестов)
[_] Часть 4 - Интеграция (3/3 теста)

Если все пункты отмечены ✓ - система полностью функциональна!

═══════════════════════════════════════════════════════════════════════

Версия: 1.0.0
Дата: 2 февраля 2026 г.
Статус: ✅ ГОТОВО К ТЕСТИРОВАНИЮ

═══════════════════════════════════════════════════════════════════════
`);
